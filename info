from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows

def copy_prod_data(df, file_path, sheet_name, row):
    try:
        # Step 1: Add columns
        df['ApproachAndClass'] = df['POST_CRM_PRA_Reporting_Approach'] + df['POST_CRM_Corep_Exposure_Class']
        df['Modified_Customer_Group'] = df['Customer_group'].apply(lambda x: 'PFS' if x == 'GPB' else x)

        # Step 2: Load workbook with macros
        wb = load_workbook(file_path, keep_vba=True)

        # Step 3: Remove sheet if it exists
        if sheet_name in wb.sheetnames:
            wb.remove(wb[sheet_name])

        # Step 4: Add new sheet and write rows
        ws = wb.create_sheet(title=sheet_name)
        for r in dataframe_to_rows(df, index=False, header=True):
            ws.append(r)

        # Step 5: Write specific cell values in 'Start' sheet
        start_ws = wb['Start']
        if sheet_name == 'Production Data':
            start_ws['F10'] = row['Project']
            start_ws['G10'] = row['Batch']
        elif sheet_name == 'Test Data':
            start_ws['F11'] = row['Project']
            start_ws['G11'] = row['Batch']

        # Step 6: Save with macros retained
        wb.save(file_path)
        print(f"✅ Data written successfully to '{sheet_name}'")

    except Exception as e:
        print(f"❌ Error in copy_prod_data: {e}")