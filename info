#!/bin/bash

# Step 1: Create folders
mkdir -p nodes

# Step 2: Create validate_input.py
cat << 'EOF' > nodes/validate_input.py
def run(input_data):
    print("Running validate_input...")
    if isinstance(input_data, str) and input_data.strip():
        return {"validated": True, "data": input_data}
    else:
        return {"validated": False, "error": "Empty or invalid input"}
EOF

# Step 3: Create transform_data.py
cat << 'EOF' > nodes/transform_data.py
def run(state):
    print("Running transform_data...")
    data = state.get("data", "")
    transformed = data.upper()
    return {"transformed_data": transformed}
EOF

# Step 4: Create langgraph_logic.py
cat << 'EOF' > langgraph_logic.py
from langgraph.graph import StateGraph
import importlib.util

def run_python_file(file_path, input_data):
    spec = importlib.util.spec_from_file_location("module.name", file_path)
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module.run(input_data)

def validate_node(state):
    return run_python_file("nodes/validate_input.py", state["input"])

def transform_node(state):
    return run_python_file("nodes/transform_data.py", state)

def build_graph():
    builder = StateGraph(dict)
    builder.set_entry_point("validate")
    builder.add_node("validate", validate_node)
    builder.add_node("transform", transform_node)
    builder.add_edge("validate", "transform")
    return builder.compile()
EOF

# Step 5: Create streamlit_app.py
cat << 'EOF' > streamlit_app.py
import streamlit as st
from langgraph_logic import build_graph

st.title("LangGraph + Streamlit Demo")
user_input = st.text_input("Enter input string:")

if st.button("Run Workflow") and user_input:
    graph = build_graph()
    result = graph.invoke({"input": user_input})
    
    st.subheader("LangGraph Output")
    st.json(result)
EOF

# Step 6: Create requirements.txt
cat << 'EOF' > requirements.txt
streamlit==1.35.0
langgraph==0.0.38
langchain==0.1.20
EOF

# Step 7: Create venv and install requirements
python -m venv .venv
source .venv/Scripts/activate

# Install required packages
pip install -r requirements.txt

# Step 8: Launch the Streamlit app
streamlit run streamlit_app.py