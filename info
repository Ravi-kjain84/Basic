import os
import win32com.client
from pathlib import Path

def convert_xls_to_xlsx_in_folder(folder_path):
    folder = Path(folder_path)
    try:
        excel = win32com.client.DispatchEx('Excel.Application')
        excel.Visible = False

        for file in folder.glob("*.xls"):
            if file.name.startswith('~$'):
                continue

            try:
                xls_path = file.resolve()
                xlsx_path = file.with_suffix('.xlsx').resolve()

                print(f"üîÑ Attempting: {xls_path.name} ‚Üí {xlsx_path.name}")

                wb = excel.Workbooks.Open(str(xls_path))
                wb.SaveAs(str(xlsx_path), FileFormat=51)  # FileFormat=51 = xlsx
                wb.Close(SaveChanges=False)

                # ‚úÖ Confirm the new file exists before deleting
                if xlsx_path.exists():
                    print(f"‚úÖ Saved: {xlsx_path.name}")
                    file.unlink()
                    print(f"üóëÔ∏è Deleted original .xls: {xls_path.name}")
                else:
                    print(f"‚ùå Save failed, NOT deleting: {xls_path.name}")

            except Exception as e:
                print(f"‚ùå Exception for {file.name}: {e}")

        excel.Quit()

    except Exception as e:
        print(f"üî• Excel COM failed: {e}")